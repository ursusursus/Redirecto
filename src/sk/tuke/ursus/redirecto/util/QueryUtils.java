package sk.tuke.ursus.redirecto.util;

import sk.tuke.ursus.redirecto.provider.RedirectoContract.Rooms;
import android.content.ContentResolver;
import android.content.ContentValues;
import android.database.Cursor;

/**
 * Pomocná trieda pre prácu s databázou
 * 
 * @author Vlastimil Breèka
 * 
 */
public class QueryUtils {

	/**
	 * Konštanta žiadnej miestnosti
	 */
	public static final int NO_ROOM_ID = -1;

	/**
	 * Príznak ne-aktuálnej miestnosti
	 */
	private static final int FLAG_NOT_CURRENT = 0;

	/**
	 * Príznak aktuálnej miestnosti
	 */
	private static final int FLAG_CURRENT = 1;

	/**
	 * Vráti ID aktuálnej miestnosti
	 * 
	 * @param resolver
	 *        ContentResolver
	 * @return ID aktuálnej miestnosti
	 */
	public static int getCurrentRoomId(ContentResolver resolver) {
		String[] columns = new String[] { Rooms.COLUMN_ID };
		String where = Rooms.COLUMN_CURRENT + "=" + FLAG_CURRENT;

		Cursor cursor = resolver.query(Rooms.CONTENT_URI, columns, where, null, null);

		int currentRoomId = NO_ROOM_ID;
		if (cursor.moveToFirst()) {
			currentRoomId = cursor.getInt(0);
		}
		cursor.close();
		return currentRoomId;
	}

	/**
	 * Nastaví ID novej lokalizovanej miestnosti
	 * 
	 * @param resolver
	 *        ContentResolver
	 * @param newCurrentRoom
	 *        ID novej miestnosti
	 * @return Úspechu operácie
	 */
	public static boolean setNewCurrentRoomId(ContentResolver resolver, int newCurrentRoom) {
		// Set flag for new current room
		ContentValues values = new ContentValues();
		values.put(Rooms.COLUMN_CURRENT, FLAG_CURRENT);
		int count = resolver.update(Rooms.CONTENT_URI,
				values,
				Rooms.COLUMN_ID + "=" + newCurrentRoom,
				null);

		if (count <= 0) {
			return false;

		} else {
			// Reset all other rows
			values.put(Rooms.COLUMN_CURRENT, FLAG_NOT_CURRENT);
			resolver.update(Rooms.CONTENT_URI,
					values,
					Rooms.COLUMN_ID + "!=" + newCurrentRoom,
					null);

			// Notify UI
			resolver.notifyChange(Rooms.CONTENT_URI, null);
			return true;
		}

	}

}
